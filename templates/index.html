<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ bot_name }} - AI Chat</title>
  <link rel="stylesheet" href="/static/modern.css">
  <link rel="stylesheet" href="/static/chat.css">
</head>

<body>
  <div class="chat-layout">
    <!-- Sidebar -->
    <div class="chat-sidebar">
      <div class="sidebar-header">
        <img src="/static/logo.png" alt="Aura AI" style="width: 200px; height: auto; display: block; margin: 0 auto;">
        <h2 class="sidebar-title">Aura AI</h2>
        <p class="sidebar-subtitle">Your AI Assistant</p>
      </div>
      <button class="new-chat-btn" onclick="startNewChat()">+ New Chat</button>
      <div class="session-list" id="session-list"></div>
    </div>

    <!-- Main Chat -->
    <div class="chat-main">
      <!-- Floating geometric shapes -->
      <div class="shape shape-1"></div>
      <div class="shape shape-2"></div>
      <div class="shape shape-3"></div>
      <div class="shape shape-4"></div>
      <div class="shape shape-5"></div>

      <!-- Header -->
      <div class="chat-header">
        <div style="display: flex; align-items: center; gap: 15px;">
          <img src="/static/logo.png" alt="Aura AI" style="width: 150px; height: auto;">
          <h1 class="chat-header-title">Chat</h1>
        </div>
        <div class="header-actions">
          <a href="{{ url_for('widget_demo') }}" class="header-btn">Widget Demo</a>
          <a href="{{ url_for('settings') }}" class="header-btn">‚öôÔ∏è Settings</a>
          <a href="{{ url_for('logout') }}" class="header-btn logout-btn">Logout</a>
        </div>
      </div>

      <!-- Messages -->
      <div class="chat-messages" id="chat-box">
        <!-- Empty state will be shown when no messages -->
        <div class="empty-state" id="empty-state">
          <h2>üëã Welcome to Aura AI</h2>
          <p>Start a conversation by typing a message below. I'm here to help you with any questions!</p>
        </div>
      </div>

      <!-- Loading -->
      <div id="loading-spinner" style="display: none;">
        <div class="spinner"></div>
      </div>

      <!-- Input -->
      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <textarea id="user-input" class="chat-input" placeholder="Type your message..." rows="1"></textarea>
          <button class="send-btn" onclick="sendMessage()">Send</button>
          <button class="voice-btn" onclick="toggleVoiceMode()" id="voice-toggle">üéôÔ∏è Voice</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let wakeRecognizer;
    let recognition;
    let isListening = false;

    // Initialize
    if (!localStorage.getItem("user_id")) {
      localStorage.setItem("user_id", "user_" + Math.random().toString(36).substring(2, 9));
    }

    const user_id = localStorage.getItem("user_id");
    let session_id = localStorage.getItem("session_id");
    const domain = "{{ base_name }}";

    window.onload = async () => {
      if (!localStorage.getItem("session_id")) {
        const newSessionId = "sess_" + Math.random().toString(36).substring(2, 10);
        localStorage.setItem("session_id", newSessionId);
        session_id = newSessionId;
      } else {
        session_id = localStorage.getItem("session_id");
      }

      try {
        const greetRes = await fetch("/greet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_id })
        });
        const greetData = await greetRes.json();
        if (greetData.greeted && greetData.messages && greetData.messages.length > 0) {
          greetData.messages.forEach(m => appendMessage("bot", m.text));
          speakText(greetData.messages[0].text);
        }
      } catch (e) {
        console.warn("Greeting fetch failed:", e);
      }

      await loadSessions();
      await loadChatHistory(session_id);
      startWakeWordListener();
    };

    // Send message
    document.getElementById("user-input").addEventListener("keydown", function (event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    async function sendMessage(optionalMessage = null) {
      const input = document.getElementById("user-input");
      const message = optionalMessage || input.value.trim();

      if (!message) return;

      appendMessage("user", message);
      input.value = "";
      document.getElementById("loading-spinner").style.display = "block";

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, session_id })
        });
        const data = await res.json();

        document.getElementById("loading-spinner").style.display = "none";
        appendMessage("bot", data.response);
        speakText(data.response);

        if (data.session_id && data.session_id !== session_id) {
          session_id = data.session_id;
          localStorage.setItem("session_id", session_id);
          await loadSessions();
        }
      } catch (err) {
        document.getElementById("loading-spinner").style.display = "none";
        appendMessage("bot", "‚ùå Server not responding.");
      }
    }

    // UI Helpers
    function linkify(text) {
      const urlRegex = /((https?:\/\/[^\s]+))/g;
      return text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
    }

    function appendMessage(role, text) {
      const chatBox = document.getElementById("chat-box");
      const emptyState = document.getElementById("empty-state");

      // Hide empty state when first message appears
      if (emptyState) {
        emptyState.style.display = 'none';
      }

      const div = document.createElement("div");
      div.className = `message ${role}`;
      div.innerHTML = linkify(text);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Sessions
    async function loadSessions() {
      const res = await fetch('/sessions');
      const sessions = await res.json();
      const container = document.getElementById("session-list");
      container.innerHTML = '';

      sessions.forEach(sess => {
        const div = document.createElement("div");
        div.className = "chat-item";
        div.innerHTML = `
          <strong>${sess.title}</strong><br>
          <small>${new Date(sess.started_at).toLocaleString()}</small>
        `;
        div.onclick = async () => {
          session_id = sess.session_id;
          localStorage.setItem("session_id", session_id);
          document.getElementById("chat-box").innerHTML = '';
          await loadChatHistory(session_id);
        };
        container.appendChild(div);
      });
    }

    async function loadChatHistory(sessionId) {
      try {
        const res = await fetch(`/session/${sessionId}?username=${user_id}&base=${domain}`);
        const data = await res.json();

        const chatBox = document.getElementById("chat-box");
        const emptyState = document.getElementById("empty-state");
        chatBox.innerHTML = "";

        if (data.messages && data.messages.length > 0) {
          // Hide empty state if there are messages
          if (emptyState) {
            chatBox.appendChild(emptyState);
            emptyState.style.display = 'none';
          }
          data.messages.forEach(msg => appendMessage(msg.sender, msg.text));
        } else {
          // Show empty state if no messages
          if (emptyState) {
            chatBox.appendChild(emptyState);
            emptyState.style.display = 'flex';
          }
        }
      } catch (err) {
        console.error("Failed to load chat history:", err);
      }
    }

    function startNewChat() {
      const newSessionId = "sess_" + Math.random().toString(36).substring(2, 10);
      session_id = newSessionId;
      localStorage.setItem("session_id", session_id);

      const chatBox = document.getElementById("chat-box");
      const emptyState = document.getElementById("empty-state");
      chatBox.innerHTML = '';

      // Re-add and show empty state
      if (emptyState) {
        chatBox.appendChild(emptyState);
        emptyState.style.display = 'flex';
      }

      loadSessions();
    }

    // Voice
    function toggleVoiceMode() {
      const button = document.getElementById("voice-toggle");

      if (isListening) {
        button.textContent = "üéôÔ∏è Voice";
        stopVoiceInput();
      } else {
        button.textContent = "üîá Stop";
        startVoiceInput();
      }
    }

    function startVoiceInput() {
      stopWakeWordListener();
      window.speechSynthesis.cancel();
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-US";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        isListening = true;
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById("user-input").value = transcript;
        sendMessage();
      };

      recognition.onerror = (event) => {
        console.error("Voice input error:", event.error);
        stopVoiceInput();
      };

      recognition.onend = () => {
        isListening = false;
        document.getElementById("voice-toggle").textContent = "üéôÔ∏è Voice";
        startWakeWordListener();
      };

      recognition.start();
    }

    function stopVoiceInput() {
      if (recognition) {
        recognition.stop();
      }
    }

    function startWakeWordListener() {
      if (wakeRecognizer) return;

      wakeRecognizer = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      wakeRecognizer.lang = "en-US";
      wakeRecognizer.continuous = true;
      wakeRecognizer.interimResults = false;

      wakeRecognizer.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
        if (transcript.includes("hello") && !isListening) {
          document.getElementById("voice-toggle").textContent = "üîá Stop";
          stopWakeWordListener();
          startVoiceInput();
        }
      };

      wakeRecognizer.onerror = (e) => {
        console.warn("Wake listener error:", e.error);
        stopWakeWordListener();
        setTimeout(startWakeWordListener, 1000);
      };

      wakeRecognizer.onend = () => {
        if (!wakeRecognizer._manuallyStopped) {
          setTimeout(startWakeWordListener, 500);
        }
      };

      wakeRecognizer.start();
      wakeRecognizer._manuallyStopped = false;
    }

    function stopWakeWordListener() {
      if (wakeRecognizer) {
        wakeRecognizer._manuallyStopped = true;
        wakeRecognizer.stop();
        wakeRecognizer = null;
      }
    }

    function speakText(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      window.speechSynthesis.speak(utterance);
    }
  </script>
</body>

</html>